---
layout: post
title: Quick and dirty SSO with LTPA
date: '2011-10-22T19:54:00.001-04:00'
author: Bill Schneider
tags: 
modified_time: '2011-10-22T19:54:46.976-04:00'
blogger_id: tag:blogger.com,1999:blog-9159309.post-836304170743336076
blogger_orig_url: http://wrschneider.blogspot.com/2011/10/quick-and-dirty-sso-with-ltpa.html
---

If you have WebSphere application server in your environment, it is in fact possible to decode the "LtpaToken" cookie in code for quick-and-dirty SSO with non-WebSphere apps.<br /><br />The main reason you might want to do this is if you have a portal-like application on WebSphere and want to link to other applications on different non-WebSphere servers. &nbsp;This is only useful if WebSphere is your main point of entry.<br /><br />Here's how you do it:<br /><br /><ul><li>Export the LTPA encryption key to a file from WebSphere using the admin console. &nbsp;You provide a passphrase and a filename. &nbsp;</li><li>Find the "com.ibm.websphere.ltpa.3DESKey" value in the exported file. &nbsp;This is the encrypted key.</li><li>Base64 decode the above key and decrypt with 3DES, using the passphrase provided. &nbsp;The decrypted value is the actual key for decrypting LTPA tokens.</li><li>Take the "LtpaToken" cookie, base64 decode it, and decrypt it with the key. &nbsp;The legacy LtpaToken cookie (which you can get with "interoperability mode") is encrypted with 3DES; the newer LtpaToken2 cookie uses AES.</li><li>Convert to String and parse. &nbsp;The string looks like "values%expiration%signature" where the expiration is a standard UNIX timestamp, which you should use to ensure the token is still valid; and the values somewhere will contain the user DN (e.g., uid=user,ou=company,dc=com).</li></ul><div>The Alfresco codebase contains a good example of how to do this in Java</div><div><a href="http://svn.alfresco.com/repos/alfresco-open-mirror/alfresco/HEAD/root/modules/quickr/source/java/org/alfresco/repo/lotus/ws/impl/auth/LtpaAuthenticator.java">http://svn.alfresco.com/repos/alfresco-open-mirror/alfresco/HEAD/root/modules/quickr/source/java/org/alfresco/repo/lotus/ws/impl/auth/LtpaAuthenticator.java</a></div><div><br /></div><div>Relevant fragments of code:</div><pre style="white-space: pre-wrap; word-wrap: break-word;" class="brush: java"><br />    private static final String AES_DECRIPTING_ALGORITHM = "AES/CBC/PKCS5Padding";<br />   private static final String DES_DECRIPTING_ALGORITHM = "DESede/ECB/PKCS5Padding";<br /><br />    private byte[] getSecretKey(String ltpa3DESKey, String ltpaPassword) throws Exception<br />    {<br />        MessageDigest md = MessageDigest.getInstance("SHA");<br />        <br />        md.update(ltpaPassword.getBytes());<br />        <br />        byte[] hash3DES = new byte[24];<br />        <br />        System.arraycopy(md.digest(), 0, hash3DES, 0, 20);<br />        <br />        Arrays.fill(hash3DES, 20, 24, (byte) 0);<br />        <br />        final Cipher cipher = Cipher.getInstance(DES_DECRIPTING_ALGORITHM);<br />        <br />        final KeySpec keySpec = new DESedeKeySpec(hash3DES);<br />        <br />        final Key secretKey = SecretKeyFactory.getInstance("DESede").generateSecret(keySpec);<br /><br />        cipher.init(Cipher.DECRYPT_MODE, secretKey);<br />        <br />        byte[] secret = cipher.doFinal(Base64.decodeBase64(ltpa3DESKey.getBytes()));<br />        <br />        return secret;<br />    }<br />    <br />    private byte[] decrypt(byte[] token, byte[] key, String algorithm) throws Exception<br />    {<br />        SecretKey sKey = null;<br /><br />        if (algorithm.indexOf("AES") != -1)<br />        {<br />            sKey = new SecretKeySpec(key, 0, 16, "AES");<br />        }<br />        else<br />        {<br />            DESedeKeySpec kSpec = new DESedeKeySpec(key);<br />            SecretKeyFactory kFact = SecretKeyFactory.getInstance("DESede");<br />            sKey = kFact.generateSecret(kSpec);<br />        }<br />        Cipher cipher = Cipher.getInstance(algorithm);<br /><br />        if (algorithm.indexOf("ECB") == -1)<br />        {<br />            if (algorithm.indexOf("AES") != -1)<br />            {<br />                IvParameterSpec ivs16 = generateIvParameterSpec(key, 16);<br />                cipher.init(Cipher.DECRYPT_MODE, sKey, ivs16);<br />            }<br />            else<br />            {<br />                IvParameterSpec ivs8 = generateIvParameterSpec(key, 8);<br />                cipher.init(Cipher.DECRYPT_MODE, sKey, ivs8);<br />            }<br />        }<br />        else<br />        {<br />            cipher.init(Cipher.DECRYPT_MODE, sKey);<br />        }<br />        return cipher.doFinal(token);<br />    }<br />    <br />    private IvParameterSpec generateIvParameterSpec(byte key[], int size)<br />    {<br />        byte[] row = new byte[size];<br />        <br />        for (int i = 0; i &lt; size; i++)<br />        {<br />            row[i] = key[i];<br />        }<br />        <br />        return new IvParameterSpec(row);<br />    }<br />// How to use it:<br />byte[] secretKey = getSecretKey(ltpa3DESKey, ltpaPassword);<br />byte[] ltpaTokenBytes = Base64.decodeBase64(ltpaToken.getBytes());<br />String token = new String(decrypt(ltpaTokenBytes, secretKey, DES_DECRIPTING_ALGORITHM));<br />// or<br />String token = new String(decrypt(ltpaTokenBytes, secretKey, AES_DECRIPTING_ALGORITHM));<br /></pre>